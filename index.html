<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç§äººæ—…è¡Œé«˜çº§å·¥ä½œå° v36.0 - Cloud Sync</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ç›´æ¥å¤ç”¨ä½ è§‚å½±è®°å½•ä¸­çš„é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCDjsmMiLV3f80dyJGCNWkpmTnoYOrjoaI",
            authDomain: "my-movies-f84ad.firebaseapp.com",
            databaseURL: "https://my-movies-f84ad-default-rtdb.firebaseio.com",
            projectId: "my-movies-f84ad",
            storageBucket: "my-movies-f84ad.firebasestorage.app",
            messagingSenderId: "575473837602",
            appId: "1:575473837602:web:2e02c0ee50565e4426cc7b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- æ ¸å¿ƒä¿®æ”¹ï¼šè®¾ç½®ä½ çš„ä¸“å± ID ---
        const myID = "Personal_Travel_Data"; // è¿™é‡Œä½ å¯ä»¥æ”¹æˆä½ å–œæ¬¢çš„åå­—ï¼Œå»ºè®®åœ¨äº‘ç«¯åŒºåˆ†å¼€
        window.dbRef = ref(db, 'travelData/' + myID);

        window.trips = {}; 
        window.activeId = null;

        // ç›‘å¬äº‘ç«¯æ•°æ®ï¼šä¸€æ—¦äº‘ç«¯å˜äº†ï¼Œç•Œé¢ç«‹åˆ»æ›´æ–°
        onValue(window.dbRef, (snapshot) => {
            const data = snapshot.val();
            window.trips = data || {};
            document.getElementById('syncStatus').innerText = "â˜ï¸ äº‘ç«¯åŒæ­¥ä¸­";
            renderSidebar();
            if (window.activeId && window.trips[window.activeId]) {
                renderTable();
            } else if (Object.keys(window.trips).length > 0) {
                loadTrip(Object.keys(window.trips)[0]);
            }
        });

        // æ¨é€æ•°æ®åˆ°äº‘ç«¯
        window.saveToCloud = function() {
            set(window.dbRef, window.trips);
            document.getElementById('syncStatus').innerText = "âŒ› æ­£åœ¨åŒæ­¥...";
        };
    </script>

    <style>
        :root {
            --sidebar-bg: #1e293b;
            --sidebar-hover: #334155;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --bg-main: #f8fafc;
            --border-color: #e2e8f0;
            --text-main: #1e293b;
            --radius: 10px;
        }

        body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg-main); color: var(--text-main); overflow: hidden; }

        /* --- ä¾§è¾¹æ  --- */
        #sidebar { width: 260px; background: var(--sidebar-bg); color: #f8fafc; display: flex; flex-direction: column; flex-shrink: 0; }
        .side-header { padding: 24px 20px; font-size: 18px; font-weight: 700; background: #0f172a; display: flex; justify-content: space-between; align-items: center; }
        .add-trip-mini { background: var(--accent); color: white; border: none; width: 28px; height: 28px; border-radius: 6px; cursor: pointer; font-size: 18px; }
        
        #trip-list { flex: 1; overflow-y: auto; padding: 10px 0; }
        .trip-item { padding: 14px 20px; cursor: pointer; font-size: 14px; display: flex; align-items: center; transition: 0.2s; color: #94a3b8; margin: 4px 12px; border-radius: 8px; position: relative; }
        .trip-item:hover { background: var(--sidebar-hover); color: white; }
        .trip-item.active { background: var(--accent); color: white; font-weight: 600; }
        .del-trip-btn { position: absolute; right: 10px; opacity: 0; color: #94a3b8; border:none; background:none; cursor:pointer; font-size:16px; }
        .trip-item:hover .del-trip-btn { opacity: 1; }
        .del-trip-btn:hover { color: #ff4d4f; }

        .sync-footer { padding: 15px; background: #0f172a; font-size: 11px; color: #64748b; border-top: 1px solid #1e293b; }

        /* --- ä¸»ç•Œé¢ --- */
        #main { flex: 1; overflow: auto; padding: 30px; position: relative; }
        .content-container { max-width: 1400px; margin: 0 auto; }

        /* çœ‹æ¿ */
        .summary-bar { display: flex; gap: 15px; margin-bottom: 25px; }
        .stat-card { background: white; flex: 1; padding: 15px 20px; border-radius: var(--radius); border: 1px solid var(--border-color); box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .stat-card .label { font-size: 11px; color: #94a3b8; font-weight: 600; text-transform: uppercase; margin-bottom: 4px; display: block; }
        .stat-card .value { font-size: 18px; font-weight: 700; color: var(--text-main); }
        .stat-card.highlight { background: #222; border: none; }
        .stat-card.highlight .label { color: #888; }
        .stat-card.highlight .value { color: #ffd700; font-size: 22px; }

        /* è¡¨æ ¼å®¹å™¨ */
        .excel-box { background: white; padding: 15px; border-radius: var(--radius); box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid var(--border-color); }
        table { border-collapse: collapse; width: 100%; min-width: 1100px; font-size: 13px; }
        th { background: #f1f5f9; color: #475569; font-weight: 600; padding: 12px 8px; border: 1px solid var(--border-color); }
        td { border: 1px solid var(--border-color); height: 44px; position: relative; transition: 0.2s; }
        
        input { width: 100%; height: 100%; border: none; background: transparent; text-align: center; outline: none; color: var(--text-main); font-size: 13px; }
        input:focus { background: #f0f7ff; }

        .cell-loc { background: #f0f9ff; }
        .cell-hotel { background: #fefce8; }
        .btn-day { background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-bottom: 20px; }

        /* åŠŸèƒ½å°å›¾æ ‡ */
        .fill-btn { position: absolute; right: 2px; top: 2px; cursor: pointer; background: white; border: 1px solid #3b82f6; color: #3b82f6; border-radius: 4px; width: 16px; height: 16px; font-size: 10px; display: flex; align-items: center; justify-content: center; opacity: 0; transition: 0.2s; z-index: 5; }
        td:hover .fill-btn { opacity: 1; }
        .row-del { color: #cbd5e1; cursor: pointer; font-size: 16px; }
        .row-del:hover { color: #ef4444; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="side-header">
        <span>âœˆï¸ æ—…è¡Œå·¥ä½œå°</span>
        <button class="add-trip-mini" onclick="addTrip()">+</button>
    </div>
    <div id="trip-list"></div>
    <div class="sync-footer">
        <span id="syncStatus">ğŸ“¡ æ­£åœ¨è¿æ¥äº‘ç«¯...</span>
    </div>
</div>

<div id="main">
    <div id="content-area" class="content-container" style="display:none;">
        <div class="summary-bar">
            <div class="stat-card"><span class="label">äº¤é€š</span><span class="value" id="sum-p1">ï¿¥0</span></div>
            <div class="stat-card"><span class="label">é¡¹ç›®</span><span class="value" id="sum-p2">ï¿¥0</span></div>
            <div class="stat-card"><span class="label">é…’åº—</span><span class="value" id="sum-p3">ï¿¥0</span></div>
            <div class="stat-card"><span class="label">é¤é¥®</span><span class="value" id="sum-p4">ï¿¥0</span></div>
            <div class="stat-card highlight"><span class="label">å…¨æ¡ˆé¢„è®¡æ€»æ”¯å‡º</span><span class="value" id="sum-all">ï¿¥0</span></div>
        </div>

        <button class="btn-day" onclick="addDay()">+ æ–°å¢æ—¥æœŸ (Day)</button>

        <div class="excel-box">
            <table id="trip-table">
                <thead>
                    <tr>
                        <th rowspan="2" style="width:50px">å¤©æ•°</th>
                        <th rowspan="2" style="width:110px">æ—¥æœŸ</th>
                        <th rowspan="2" style="width:130px">æ‰€åœ¨åœ°</th>
                        <th rowspan="2" style="width:80px">æ—¶é—´</th>
                        <th colspan="2" style="background:#ecfdf5">äº¤é€š</th>
                        <th colspan="2" style="background:#fefce8">è¡Œç¨‹å®‰æ’</th>
                        <th colspan="2" style="background:#fff7ed">ä½å®¿é…’åº—</th>
                        <th colspan="2" style="background:#fef2f2">é¤é¥®</th>
                        <th rowspan="2" style="width:40px">åˆ </th>
                    </tr>
                    <tr>
                        <th style="background:#ecfdf5">è¯¦æƒ…</th><th style="background:#ecfdf5">é‡‘é¢</th>
                        <th style="background:#fefce8">è¯¦æƒ…</th><th style="background:#fefce8">é‡‘é¢</th>
                        <th style="background:#fff7ed">åç§°</th><th style="background:#fff7ed">é‡‘é¢</th>
                        <th style="background:#fef2f2">é¡¹ç›®</th><th style="background:#fef2f2">é‡‘é¢</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- æ—…è¡Œé€»è¾‘ä»£ç  ---
    
    function addTrip() {
        const name = prompt("ç»™ä½ çš„æ–°æ—…è¡Œèµ·ä¸ªåå­—ï¼š");
        if (!name) return;
        const id = 'trip_' + Date.now();
        window.trips[id] = { name, days: [{ date: '', rows: [{ loc: 'åŸå¸‚', time: '09:00', t1: '', p1: 0, t2: '', p2: 0, h_t: 'é…’åº—', p3: 0, t4: '', p4: 0 }] }] };
        window.saveToCloud();
        loadTrip(id);
    }

    function loadTrip(id) {
        window.activeId = id;
        renderSidebar();
        renderTable();
        document.getElementById('content-area').style.display = 'block';
    }

    function deleteTrip(id, e) {
        e.stopPropagation();
        if(confirm("ç¡®å®šæ°¸ä¹…åˆ é™¤è¿™ä¸ªè¡Œç¨‹å—ï¼Ÿäº‘ç«¯æ•°æ®ä¹Ÿå°†æ¶ˆå¤±ã€‚")) {
            delete window.trips[id];
            if(window.activeId === id) {
                window.activeId = null;
                document.getElementById('content-area').style.display = 'none';
            }
            window.saveToCloud();
        }
    }

    function addDay() {
        window.trips[window.activeId].days.push({ date: '', rows: [{ loc: 'æ–°åœ°ç‚¹', time: '09:00', t1: '', p1: 0, t2: '', p2: 0, h_t: 'æ–°é…’åº—', p3: 0, t4: '', p4: 0 }] });
        window.saveToCloud();
    }

    function addRow(dIdx) {
        window.trips[window.activeId].days[dIdx].rows.push({ loc: '', time: '', t1: '', p1: 0, t2: '', p2: 0, h_t: '', p3: 0, t4: '', p4: 0 });
        window.saveToCloud();
    }

    function updateVal(dIdx, rIdx, key, val) {
        window.trips[window.activeId].days[dIdx].rows[rIdx][key] = val;
        // å¦‚æœæ”¹çš„æ˜¯åŸå¸‚æˆ–é…’åº—ï¼Œéœ€è¦é‡ç»˜æ¥å¤„ç†åˆå¹¶é€»è¾‘ï¼›å¦‚æœåªæ˜¯æ”¹é‡‘é¢ï¼Œé™é»˜ä¸Šä¼ 
        if(['loc', 'h_t'].includes(key)) renderTable(); 
        window.saveToCloud();
    }

    function fillDown(dIdx, rIdx, key) {
        const rows = window.trips[window.activeId].days[dIdx].rows;
        const val = rows[rIdx][key];
        for(let i = rIdx + 1; i < rows.length; i++) {
            if(rows[i][key].trim() === "") rows[i][key] = val;
            else break;
        }
        renderTable();
        window.saveToCloud();
    }

    function renderSidebar() {
        const list = document.getElementById('trip-list');
        list.innerHTML = '';
        Object.keys(window.trips).forEach(id => {
            const div = document.createElement('div');
            div.className = `trip-item ${id === window.activeId ? 'active' : ''}`;
            div.innerHTML = `<span>ğŸ“ ${window.trips[id].name}</span><button class="del-trip-btn" onclick="deleteTrip('${id}', event)">âœ•</button>`;
            div.onclick = () => loadTrip(id);
            list.appendChild(div);
        });
    }

    function renderTable() {
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';
        const trip = window.trips[window.activeId];
        if(!trip) return;

        trip.days.forEach((day, dIdx) => {
            day.rows.forEach((row, rIdx) => {
                const tr = document.createElement('tr');

                if (rIdx === 0) {
                    tr.innerHTML += `<td rowspan="${day.rows.length}" style="text-align:center;font-weight:bold;color:#64748b">D${dIdx + 1}<br><button style="font-size:10px;margin-top:5px;cursor:pointer" onclick="addRow(${dIdx})">+è¡Œ</button></td>`;
                    tr.innerHTML += `<td rowspan="${day.rows.length}"><input type="date" value="${day.date}" onchange="window.trips['${window.activeId}'].days[${dIdx}].date=this.value;window.saveToCloud()"></td>`;
                }

                // åŸå¸‚åˆå¹¶é€»è¾‘
                let locSpan = 1;
                if (rIdx > 0 && day.rows[rIdx-1].loc !== "" && day.rows[rIdx-1].loc === row.loc) { } 
                else {
                    for(let i = rIdx + 1; i < day.rows.length; i++) {
                        if(day.rows[i].loc !== "" && day.rows[i].loc === row.loc) locSpan++; else break;
                    }
                    tr.innerHTML += `<td rowspan="${locSpan}" class="cell-loc">
                        <input value="${row.loc}" onblur="updateVal(${dIdx},${rIdx},'loc',this.value)">
                        <span class="fill-btn" onclick="fillDown(${dIdx},${rIdx},'loc')">â†“</span>
                    </td>`;
                }

                tr.innerHTML += `
                    <td><input value="${row.time}" onblur="updateVal(${dIdx},${rIdx},'time',this.value)"></td>
                    <td><input value="${row.t1}" onblur="updateVal(${dIdx},${rIdx},'t1',this.value)"></td>
                    <td><input type="number" value="${row.p1}" onblur="updateVal(${dIdx},${rIdx},'p1',this.value)"></td>
                    <td><input value="${row.t2}" onblur="updateVal(${dIdx},${rIdx},'t2',this.value)"></td>
                    <td><input type="number" value="${row.p2}" onblur="updateVal(${dIdx},${rIdx},'p2',this.value)"></td>
                `;

                // é…’åº—åˆå¹¶é€»è¾‘
                let hotelSpan = 1;
                if (rIdx > 0 && day.rows[rIdx-1].h_t !== "" && day.rows[rIdx-1].h_t === row.h_t) { } 
                else {
                    for(let i = rIdx + 1; i < day.rows.length; i++) {
                        if(day.rows[i].h_t !== "" && day.rows[i].h_t === row.h_t) hotelSpan++; else break;
                    }
                    tr.innerHTML += `<td rowspan="${hotelSpan}" class="cell-hotel">
                        <input value="${row.h_t}" onblur="updateVal(${dIdx},${rIdx},'h_t',this.value)">
                        <span class="fill-btn" onclick="fillDown(${dIdx},${rIdx},'h_t')">â†“</span>
                    </td>`;
                    tr.innerHTML += `<td rowspan="${hotelSpan}" class="cell-hotel"><input type="number" value="${row.p3}" onblur="updateVal(${dIdx},${rIdx},'p3',this.value)"></td>`;
                }

                tr.innerHTML += `
                    <td><input value="${row.t4}" onblur="updateVal(${dIdx},${rIdx},'t4',this.value)"></td>
                    <td><input type="number" value="${row.p4}" onblur="updateVal(${dIdx},${rIdx},'p4',this.value)"></td>
                    <td style="text-align:center"><span class="row-del" onclick="delRow(${dIdx},${rIdx})">âœ•</span></td>
                `;
                tbody.appendChild(tr);
            });
        });
        updateStats();
    }

    function delRow(dIdx, rIdx) {
        window.trips[window.activeId].days[dIdx].rows.splice(rIdx, 1);
        if(window.trips[window.activeId].days[dIdx].rows.length === 0) window.trips[window.activeId].days.splice(dIdx, 1);
        renderTable();
        window.saveToCloud();
    }

    function updateStats() {
        let p1=0, p2=0, p3=0, p4=0;
        const trip = window.trips[window.activeId];
        if(!trip) return;
        trip.days.forEach(day => {
            day.rows.forEach((row, rIdx) => {
                p1 += Number(row.p1) || 0; p2 += Number(row.p2) || 0; p4 += Number(row.p4) || 0;
                // é…’åº—é‡‘é¢åªç®—åˆå¹¶å—çš„ç¬¬ä¸€è¡Œ
                if (rIdx === 0 || day.rows[rIdx-1].h_t === "" || day.rows[rIdx-1].h_t !== row.h_t) p3 += Number(row.p3) || 0;
            });
        });
        document.getElementById('sum-p1').innerText = 'ï¿¥' + p1.toLocaleString();
        document.getElementById('sum-p2').innerText = 'ï¿¥' + p2.toLocaleString();
        document.getElementById('sum-p3').innerText = 'ï¿¥' + p3.toLocaleString();
        document.getElementById('sum-p4').innerText = 'ï¿¥' + p4.toLocaleString();
        document.getElementById('sum-all').innerText = 'ï¿¥' + (p1+p2+p3+p4).toLocaleString();
    }
</script>
</body>
</html>