<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç§äººæ—…è¡Œé«˜çº§å·¥ä½œå° v37.1 - Manual Rowspan</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCDjsmMiLV3f80dyJGCNWkpmTnoYOrjoaI",
            authDomain: "my-movies-f84ad.firebaseapp.com",
            databaseURL: "https://my-movies-f84ad-default-rtdb.firebaseio.com",
            projectId: "my-movies-f84ad",
            storageBucket: "my-movies-f84ad.firebasestorage.app",
            messagingSenderId: "575473837602",
            appId: "1:575473837602:web:2e02c0ee50565e4426cc7b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const myID = "Personal_Travel_Data"; 
        window.dbRef = ref(db, 'travelData/' + myID);

        window.trips = {}; 
        window.activeId = null;

        onValue(window.dbRef, (snapshot) => {
            const data = snapshot.val();
            window.trips = data || {};
            document.getElementById('syncStatus').innerText = "â˜ï¸ äº‘ç«¯å·²åŒæ­¥";
            renderSidebar();
            if (window.activeId && window.trips[window.activeId]) {
                renderTable();
            } else if (Object.keys(window.trips).length > 0 && !window.activeId) {
                loadTrip(Object.keys(window.trips)[0]);
            }
        });

        window.saveToCloud = function() {
            set(window.dbRef, window.trips);
            document.getElementById('syncStatus').innerText = "âŒ› æ­£åœ¨åŒæ­¥...";
        };
    </script>

    <style>
        :root {
            --sidebar-bg: #1e293b;
            --accent: #3b82f6;
            --bg-main: #f8fafc;
            --border-color: #e2e8f0;
            --text-main: #1e293b;
            --radius: 12px;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg-main); color: var(--text-main); overflow: hidden; }

        /* ä¾§è¾¹æ  */
        #sidebar { width: 240px; background: var(--sidebar-bg); color: #f8fafc; display: flex; flex-direction: column; flex-shrink: 0; }
        .side-header { padding: 24px 20px; font-size: 18px; font-weight: 700; background: #0f172a; display: flex; justify-content: space-between; align-items: center; }
        #trip-list { flex: 1; overflow-y: auto; padding: 10px 0; }
        .trip-item { padding: 14px 20px; cursor: pointer; font-size: 14px; color: #94a3b8; margin: 4px 12px; border-radius: 8px; }
        .trip-item.active { background: var(--accent); color: white; }

        /* ä¸»ç•Œé¢ */
        #main { flex: 1; overflow: auto; padding: 30px; }
        .content-container { width: 100%; max-width: 1600px; margin: 0 auto; }

        .excel-box { background: white; padding: 15px; border-radius: var(--radius); box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid var(--border-color); overflow-x: auto; }
        table { border-collapse: collapse; width: 100%; font-size: 13px; table-layout: auto; }
        th { background: #f8fafc; color: #64748b; font-weight: 600; padding: 12px 8px; border: 1px solid var(--border-color); white-space: nowrap; }
        
        td { border: 1px solid var(--border-color); min-height: 44px; position: relative; word-break: break-all; vertical-align: middle; }
        
        .day-odd { background-color: #ffffff; }
        .day-even { background-color: #f8fafc; }
        .day-start { border-top: 2.5px solid #cbd5e1 !important; }

        /* è¾“å…¥åŒºåŸŸè‡ªé€‚åº”é«˜åº¦ */
        .cell-content {
            width: 100%; border: none; background: transparent; text-align: center; outline: none; 
            font-size: 13px; color: var(--text-main); padding: 10px 5px; box-sizing: border-box;
            display: block; resize: none; overflow: hidden; min-height: 38px;
        }

        /* åˆå¹¶å¡«å……æŒ‰é’® */
        .fill-btn { 
            position: absolute; right: 2px; top: 2px; cursor: pointer; background: white; 
            border: 1px solid #3b82f6; color: #3b82f6; border-radius: 4px; width: 16px; 
            height: 16px; font-size: 10px; display: flex; align-items: center; justify-content: center; 
            opacity: 0; z-index: 5; transition: 0.2s; 
        }
        td:hover .fill-btn { opacity: 1; }

        .row-insert-btn {
            position: absolute; bottom: -10px; right: 0px; z-index: 10; width: 20px; height: 20px; 
            background: var(--accent); color: white; border: none; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; opacity: 0;
        }
        tr:hover .row-insert-btn { opacity: 1; }

        .btn-day { background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="side-header"><span>âœˆï¸ è¡Œç¨‹è®¡åˆ’</span><button onclick="addTrip()" style="background:var(--accent); border:none; color:white; border-radius:4px; padding:2px 8px; cursor:pointer">+</button></div>
    <div id="trip-list"></div>
    <div class="sync-footer" style="padding:15px; font-size:11px; color:#64748b; background:#0f172a;" id="syncStatus">ğŸ“¡ æ­£åœ¨è¿æ¥...</div>
</div>

<div id="main">
    <div id="content-area" class="content-container" style="display:none;">
        <button class="btn-day" onclick="addDay()">+ æ–°å¢æ—¥æœŸ (New Day)</button>
        <div class="excel-box">
            <table id="trip-table">
                <thead>
                    <tr>
                        <th rowspan="2" style="width:50px">å¤©æ•°</th>
                        <th rowspan="2" style="width:110px">æ—¥æœŸ</th>
                        <th rowspan="2" style="min-width:100px">æ‰€åœ¨åœ°</th>
                        <th rowspan="2" style="min-width:80px">æ—¶é—´</th>
                        <th colspan="2">äº¤é€š</th><th colspan="2">è¡Œç¨‹å®‰æ’</th>
                        <th colspan="2">ä½å®¿é…’åº—</th><th colspan="2">é¤é¥®</th>
                        <th rowspan="2" style="width:40px">åˆ </th>
                    </tr>
                    <tr>
                        <th>è¯¦æƒ…</th><th>é‡‘é¢</th><th>è¯¦æƒ…</th><th>é‡‘é¢</th>
                        <th>åç§°</th><th>é‡‘é¢</th><th>è¯¦æƒ…</th><th>é‡‘é¢</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function renderTable() {
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';
        const trip = window.trips[window.activeId];
        if(!trip) return;

        trip.days.forEach((day, dIdx) => {
            const dayClass = (dIdx % 2 === 0) ? 'day-odd' : 'day-even';
            day.rows.forEach((row, rIdx) => {
                const tr = document.createElement('tr');
                tr.className = dayClass;
                if (rIdx === 0) tr.classList.add('day-start');

                // 1. å¤©æ•° & æ—¥æœŸ (å§‹ç»ˆåˆå¹¶)
                if (rIdx === 0) {
                    tr.innerHTML += `<td rowspan="${day.rows.length}" style="text-align:center; font-weight:bold; background:inherit;">D${dIdx + 1}</td>`;
                    tr.innerHTML += `<td rowspan="${day.rows.length}" style="background:inherit; text-align:center;">
                        <input type="date" value="${day.date}" onchange="updateDayDate(${dIdx}, this.value)" style="border:none; background:transparent; font-size:13px;">
                    </td>`;
                }
                
                // 2. æ‰€æœ‰å¯åˆå¹¶åˆ—å®šä¹‰
                const config = [
                    {key: 'loc', bg: (dIdx % 2 === 0 ? '#f0f9ff' : '#e0f2fe')},
                    {key: 'time', bg: 'inherit'},
                    {key: 't1', bg: 'inherit'}, {key: 'p1', bg: 'inherit'},
                    {key: 't2', bg: 'inherit'}, {key: 'p2', bg: 'inherit'},
                    {key: 'h_t', bg: (dIdx % 2 === 0 ? '#fefce8' : '#fef9c3')}, {key: 'p3', bg: (dIdx % 2 === 0 ? '#fefce8' : '#fef9c3')},
                    {key: 't4', bg: 'inherit'}, {key: 'p4', bg: 'inherit'}
                ];

                config.forEach(col => {
                    // æ ¸å¿ƒé€»è¾‘ï¼šåªæœ‰å½“å‰è¡Œæ˜¯è¯¥åˆ—åˆå¹¶å—çš„èµ·ç‚¹æ—¶ï¼Œæ‰æ¸²æŸ“å•å…ƒæ ¼
                    if (isCellStart(day.rows, rIdx, col.key)) {
                        const span = getCellSpan(day.rows, rIdx, col.key);
                        const td = document.createElement('td');
                        if (span > 1) td.rowSpan = span;
                        td.style.background = col.bg;

                        const area = document.createElement('textarea');
                        area.className = 'cell-content';
                        area.value = row[col.key] || '';
                        area.onblur = (e) => updateVal(dIdx, rIdx, col.key, e.target.value);
                        area.oninput = function() { this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px'; };
                        
                        td.appendChild(area);
                        
                        // ä¸‹ç®­å¤´åˆå¹¶å¡«å……æŒ‰é’®
                        const fBtn = document.createElement('span');
                        fBtn.className = 'fill-btn';
                        fBtn.innerHTML = 'â†“';
                        fBtn.onclick = () => manualMergeDown(dIdx, rIdx, col.key);
                        td.appendChild(fBtn);

                        tr.appendChild(td);
                        // åˆå§‹è°ƒæ•´é«˜åº¦
                        setTimeout(() => { area.style.height = 'auto'; area.style.height = area.scrollHeight + 'px'; }, 0);
                    }
                });

                // 3. åˆ é™¤ä¸æ’è¡Œ
                tr.innerHTML += `<td style="text-align:center;cursor:pointer;color:#cbd5e1" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='#cbd5e1'" onclick="delRow(${dIdx},${rIdx})">
                    âœ• <button class="row-insert-btn" onclick="event.stopPropagation(); insertRow(${dIdx}, ${rIdx})">+</button>
                </td>`;
                tbody.appendChild(tr);
            });
        });
    }

    // --- æ ¸å¿ƒåˆå¹¶ç®—æ³• (åŸºäº36.6å¹¶ä¿®å¤) ---
    
    // åˆ¤æ–­æ˜¯å¦æ˜¯åˆå¹¶çš„èµ·å§‹ç‚¹ï¼šå¿…é¡»å†…å®¹éç©ºï¼Œä¸”ä¸ä¸Šä¸€è¡Œç›¸åŒæ‰è§†ä¸ºåˆå¹¶ã€‚
    // å¦‚æœç”¨æˆ·åªæ˜¯è¾“å…¥äº†ç›¸åŒå†…å®¹ä½†ä¸æƒ³åˆå¹¶ï¼Œæœ¬é€»è¾‘é€šè¿‡å¼ºåˆ¶æ‰‹åŠ¨è§¦å‘æ¥æ§åˆ¶ã€‚
    function isCellStart(rows, rIdx, key) {
        if (rIdx === 0) return true;
        const cur = String(rows[rIdx][key]).trim();
        const prev = String(rows[rIdx-1][key]).trim();
        // åªæœ‰å½“ [å†…å®¹ç›¸åŒ] ä¸” [ä¸ä¸ºç©º] æ—¶ï¼Œæ‰è®¤ä¸ºæ˜¯åˆå¹¶éƒ¨åˆ†ï¼Œä¸é‡æ–°æ¸²æŸ“ã€‚
        return !(cur !== "" && cur === prev);
    }

    function getCellSpan(rows, rIdx, key) {
        let span = 1;
        const val = String(rows[rIdx][key]).trim();
        if (val === "") return 1;
        for (let i = rIdx + 1; i < rows.length; i++) {
            if (String(rows[i][key]).trim() === val) span++;
            else break;
        }
        return span;
    }

    // ç‚¹å‡»æŒ‰é’®ï¼šå‘ä¸‹å¡«å……ä¸€è¡Œå†…å®¹ï¼Œä»è€Œâ€œæ¿€æ´»â€ä¸Šé¢çš„ isCellStart åˆ¤æ–­å®ç°åˆå¹¶
    function manualMergeDown(dIdx, rIdx, key) {
        const rows = window.trips[window.activeId].days[dIdx].rows;
        if (rIdx + 1 < rows.length) {
            rows[rIdx + 1][key] = rows[rIdx][key]; 
            renderTable();
            window.saveToCloud();
        }
    }

    // --- åŸºç¡€æ•°æ®ç®¡ç† ---
    function updateVal(dIdx, rIdx, key, val) {
        const rows = window.trips[window.activeId].days[dIdx].rows;
        const oldVal = rows[rIdx][key];
        rows[rIdx][key] = val;
        // å¦‚æœåŸæœ¬æ˜¯åˆå¹¶çŠ¶æ€ï¼ŒåŒæ­¥æ›´æ–°ä¸‹æ–¹çš„å†…å®¹
        for(let i = rIdx + 1; i < rows.length; i++) {
            if (String(rows[i][key]).trim() === String(oldVal).trim() && oldVal !== "") {
                rows[i][key] = val;
            } else break;
        }
        renderTable(); 
        window.saveToCloud();
    }

    function updateDayDate(dIdx, val) { window.trips[window.activeId].days[dIdx].date = val; window.saveToCloud(); }
    function addTrip() { const name = prompt("è¡Œç¨‹åç§°ï¼š"); if (name) { const id = 't_' + Date.now(); window.trips[id] = { name, days: [{ date: '', rows: [{ loc: '', time: '', t1: '', p1: 0, t2: '', p2: 0, h_t: '', p3: 0, t4: '', p4: 0 }] }] }; window.saveToCloud(); loadTrip(id); } }
    function loadTrip(id) { window.activeId = id; renderSidebar(); renderTable(); document.getElementById('content-area').style.display = 'block'; }
    function renderSidebar() {
        const list = document.getElementById('trip-list'); list.innerHTML = '';
        Object.keys(window.trips).forEach(id => {
            const div = document.createElement('div');
            div.className = `trip-item ${id === window.activeId ? 'active' : ''}`;
            div.innerText = "ğŸ“ " + window.trips[id].name;
            div.onclick = () => loadTrip(id);
            list.appendChild(div);
        });
    }
    function addDay() { window.trips[window.activeId].days.push({ date: '', rows: [{ loc: '', time: '', t1: '', p1: 0, t2: '', p2: 0, h_t: '', p3: 0, t4: '', p4: 0 }] }); renderTable(); window.saveToCloud(); }
    function insertRow(dIdx, rIdx) { window.trips[window.activeId].days[dIdx].rows.splice(rIdx + 1, 0, { loc: '', time: '', t1: '', p1: 0, t2: '', p2: 0, h_t: '', p3: 0, t4: '', p4: 0 }); renderTable(); window.saveToCloud(); }
    function delRow(dIdx, rIdx) { if(confirm("ç¡®å®šåˆ é™¤æ­¤è¡Œï¼Ÿ")) { window.trips[window.activeId].days[dIdx].rows.splice(rIdx, 1); if(window.trips[window.activeId].days[dIdx].rows.length === 0) window.trips[window.activeId].days.splice(dIdx, 1); renderTable(); window.saveToCloud(); } }
</script>
</body>
</html>
