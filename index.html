<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç§äººæ—…è¡Œé«˜çº§å·¥ä½œå° v37.7 - è´¦ç›®æ ¡å‡†ç‰ˆ</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCDjsmMiLV3f80dyJGCNWkpmTnoYOrjoaI",
            authDomain: "my-movies-f84ad.firebaseapp.com",
            databaseURL: "https://my-movies-f84ad-default-rtdb.firebaseio.com",
            projectId: "my-movies-f84ad",
            storageBucket: "my-movies-f84ad.firebasestorage.app",
            messagingSenderId: "575473837602",
            appId: "1:575473837602:web:2e02c0ee50565e4426cc7b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const myID = "Personal_Travel_Data"; 
        window.dbRef = ref(db, 'travelData/' + myID);

        window.trips = {}; 
        window.activeId = null;

        onValue(window.dbRef, (snapshot) => {
            const data = snapshot.val();
            window.trips = data || {};
            document.getElementById('syncStatus').innerText = "â˜ï¸ æ•°æ®å·²æ ¡å‡†å¹¶åŒæ­¥";
            renderSidebar();
            if (window.activeId && window.trips[window.activeId]) renderTable();
            else if (Object.keys(window.trips).length > 0 && !window.activeId) loadTrip(Object.keys(window.trips)[0]);
        });

        window.saveToCloud = () => set(window.dbRef, window.trips);
    </script>

    <style>
        :root { --sidebar-bg: #1e293b; --accent: #3b82f6; --bg-main: #f8fafc; --border-color: #e2e8f0; --radius: 12px; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg-main); overflow: hidden; }
        #sidebar { width: 260px; background: var(--sidebar-bg); color: #f8fafc; display: flex; flex-direction: column; flex-shrink: 0; }
        .side-header { padding: 24px 20px; font-size: 18px; font-weight: 700; background: #0f172a; display: flex; justify-content: space-between; align-items: center; }
        #trip-list { flex: 1; overflow-y: auto; padding: 10px 0; }
        .trip-item { padding: 14px 20px; cursor: pointer; color: #94a3b8; margin: 4px 12px; border-radius: 8px; transition: 0.2s; }
        .trip-item.active { background: var(--accent); color: white; font-weight: 600; }
        #main { flex: 1; overflow: auto; padding: 30px; }
        
        /* ç»Ÿè®¡æ æ ·å¼ */
        .summary-bar { display: flex; gap: 12px; margin-bottom: 25px; flex-wrap: wrap; }
        .stat-card { background: white; flex: 1; min-width: 140px; padding: 15px 18px; border-radius: var(--radius); border: 1px solid var(--border-color); box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .stat-card.grand-total { background: #2563eb; color: white; border: none; flex: 1.5; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .stat-card .label { font-size: 11px; color: #94a3b8; font-weight: 600; margin-bottom: 4px; display: block; }
        .grand-total .label { color: #bfdbfe; }
        .stat-card .value { font-size: 18px; font-weight: 700; }
        .grand-total .value { font-size: 22px; }

        .excel-box { background: white; padding: 15px; border-radius: var(--radius); border: 1px solid var(--border-color); box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        table { border-collapse: collapse; width: 100%; min-width: 1100px; font-size: 13px; table-layout: fixed; }
        th { background: #f8fafc; color: #64748b; padding: 10px 8px; border: 1px solid var(--border-color); font-size: 11px; }
        td { border: 1px solid var(--border-color); height: 44px; position: relative; background: white; }
        input { width: 100%; height: 100%; border: none; background: transparent; text-align: center; outline: none; }
        .day-start { border-top: 2px solid #cbd5e1 !important; }
        .fill-btn { position: absolute; right: 2px; top: 2px; cursor: pointer; background: white; border: 1px solid #3b82f6; color: #3b82f6; border-radius: 4px; width: 16px; height: 16px; font-size: 10px; display: flex; align-items: center; justify-content: center; opacity: 0; z-index: 5; }
        td:hover .fill-btn { opacity: 1; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="side-header"><span>âœˆï¸ è¡Œç¨‹ç®¡ç†</span><button onclick="addTrip()" style="background:var(--accent);border:none;color:white;width:28px;border-radius:6px;cursor:pointer">+</button></div>
    <div id="trip-list"></div>
    <div style="padding:15px; background:#0f172a; font-size:11px; color:#64748b" id="syncStatus">ğŸ“¡ æ­£åœ¨åŒæ­¥...</div>
</div>

<div id="main">
    <div id="content-area" style="display:none">
        <div class="summary-bar">
            <div class="stat-card grand-total"><span class="label">å…¨è¡Œç¨‹æ€»é¢„ç®—</span><span class="value" id="sum-grand">ï¿¥0</span></div>
            <div class="stat-card"><span class="label">äº¤é€šè´¹æ€»è®¡</span><span class="value" id="sum-p1">ï¿¥0</span></div>
            <div class="stat-card"><span class="label">é¡¹ç›®è´¹æ€»è®¡</span><span class="value" id="sum-p2">ï¿¥0</span></div>
            <div class="stat-card"><span class="label">é…’åº—è´¹æ€»è®¡</span><span class="value" id="sum-p3">ï¿¥0</span></div>
            <div class="stat-card"><span class="label">é¤é¥®è´¹æ€»è®¡</span><span class="value" id="sum-p4">ï¿¥0</span></div>
        </div>
        
        <button onclick="addDay()" style="background:#10b981; color:white; border:none; padding:10px 22px; border-radius:8px; cursor:pointer; font-weight:600; margin-bottom:20px;">+ æ–°å¢æ—¥æœŸ</button>

        <div class="excel-box">
            <table>
                <thead>
                    <tr>
                        <th rowspan="2" style="width:45px">å¤©æ•°</th><th rowspan="2" style="width:120px">æ—¥æœŸ</th>
                        <th rowspan="2" style="width:130px">æ‰€åœ¨åœ°</th><th rowspan="2" style="width:80px">æ—¶é—´</th>
                        <th colspan="2">äº¤é€š (â†“åˆ†æ‘Š)</th><th colspan="2">è¡Œç¨‹é¡¹ç›®</th>
                        <th colspan="2">é…’åº— (â†“æŒ‰æ™šå¹³æ‘Š)</th><th colspan="2">é¤é¥®</th>
                        <th rowspan="2" style="width:40px">åˆ </th>
                    </tr>
                    <tr>
                        <th>è¯¦æƒ…</th><th>é‡‘é¢</th><th>è¯¦æƒ…</th><th>é‡‘é¢</th>
                        <th>åç§°</th><th>é‡‘é¢</th><th>è¯¦æƒ…</th><th>é‡‘é¢</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function parseMath(str) {
        if (!str || typeof str !== 'string') return str;
        if (!/^[\d\+\-\*\/\.\(\)\s]+$/.test(str)) return str;
        try { 
            const res = new Function(`return ${str}`)(); 
            return isFinite(res) ? Number(parseFloat(res.toFixed(2))) : str;
        } catch(e) { return str; }
    }

    function renderTable() {
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';
        const trip = window.trips[window.activeId];
        if(!trip) return;

        trip.days.forEach((day, dIdx) => {
            day.rows.forEach((row, rIdx) => {
                const tr = document.createElement('tr');
                if (rIdx === 0) tr.classList.add('day-start');
                if (rIdx === 0) {
                    tr.innerHTML += `<td rowspan="${day.rows.length}" style="text-align:center; font-weight:bold; background:#f8fafc">D${dIdx+1}</td>`;
                    tr.innerHTML += `<td rowspan="${day.rows.length}"><input type="date" value="${day.date}" onchange="updateDayDate(${dIdx}, this.value)"></td>`;
                }
                renderCell(tr, dIdx, rIdx, 'loc', (dIdx%2==0?'#f0f9ff':'#e0f2fe'), true);
                tr.innerHTML += `<td><input value="${row.time}" onblur="updateVal(${dIdx},${rIdx},'time',this.value)"></td>`;
                renderCell(tr, dIdx, rIdx, 't1', 'white', true, 'p1');
                tr.innerHTML += `<td><input value="${row.t2}" onblur="updateVal(${dIdx},${rIdx},'t2',this.value)"></td>`;
                tr.innerHTML += `<td><input value="${row.p2}" onblur="updateMath(${dIdx},${rIdx},'p2',this.value)"></td>`;
                renderCell(tr, dIdx, rIdx, 'h_t', (dIdx%2==0?'#fefce8':'#fef9c3'), true, 'p3');
                tr.innerHTML += `<td><input value="${row.t4}" onblur="updateVal(${dIdx},${rIdx},'t4',this.value)"></td>`;
                tr.innerHTML += `<td><input value="${row.p4}" onblur="updateMath(${dIdx},${rIdx},'p4',this.value)"></td>`;
                tr.innerHTML += `<td style="text-align:center; cursor:pointer; color:#ccc" onclick="delRow(${dIdx},${rIdx})">âœ•</td>`;
                tbody.appendChild(tr);
            });
        });
        updateStats(); // æ¸²æŸ“å®Œåç«‹å³è®¡ç®—
    }

    function renderCell(tr, dIdx, rIdx, key, bg, hasFill, pKey) {
        const rows = window.trips[window.activeId].days[dIdx].rows;
        const val = rows[rIdx][key] || "";
        // åˆå¹¶åˆ¤æ–­é€»è¾‘ï¼šå¦‚æœæ˜¯åŒåæ ¼ï¼Œåˆ™ä¸æ¸²æŸ“ï¼ˆè§†è§‰éšè—ï¼‰
        if (rIdx > 0 && val !== "" && val === rows[rIdx-1][key]) return;

        let span = 1;
        if (val !== "") {
            for (let i = rIdx + 1; i < rows.length; i++) {
                if (rows[i][key] === val) span++; else break;
            }
        }
        const td = document.createElement('td');
        if (span > 1) td.rowSpan = span;
        td.style.background = bg;
        td.innerHTML = `<input value="${val}" onblur="updateVal(${dIdx},${rIdx},'${key}',this.value)">`;
        if (hasFill) td.innerHTML += `<span class="fill-btn" onclick="smartFillè”åŠ¨(${dIdx},${rIdx},'${key}','${pKey}')">â†“</span>`;
        tr.appendChild(td);

        if (pKey) {
            const tdP = document.createElement('td');
            if (span > 1) tdP.rowSpan = span;
            tdP.style.background = bg;
            tdP.innerHTML = `<input value="${rows[rIdx][pKey]}" onblur="updateMath(${dIdx},${rIdx},'${pKey}',this.value)">`;
            tr.appendChild(tdP);
        }
    }

    // --- æ ¸å¿ƒä¿®æ­£ï¼šè§†è§‰å¯¹é½ç»Ÿè®¡å¼•æ“ ---
    window.updateStats = () => {
        let p1=0, p2=0, p3=0, p4=0;
        const trip = window.trips[window.activeId];
        if(!trip) return;

        trip.days.forEach(day => {
            day.rows.forEach((row, rIdx) => {
                // äº¤é€š (p1) åªæœ‰åœ¨å®ƒæ˜¯åˆå¹¶æ¡†çš„é¦–è¡Œï¼ˆæˆ–è€…æ²¡åˆå¹¶ï¼‰æ—¶æ‰ç»Ÿè®¡
                if (rIdx === 0 || row.t1 === "" || row.t1 !== day.rows[rIdx-1].t1) {
                    p1 += Number(row.p1) || 0;
                }
                // é¡¹ç›® (p2) é€è¡Œç»Ÿè®¡
                p2 += Number(row.p2) || 0;
                // é…’åº— (p3) åªæœ‰åœ¨åˆå¹¶æ¡†é¦–è¡Œç»Ÿè®¡
                if (rIdx === 0 || row.h_t === "" || row.h_t !== day.rows[rIdx-1].h_t) {
                    p3 += Number(row.p3) || 0;
                }
                // é¤é¥® (p4) é€è¡Œç»Ÿè®¡
                p4 += Number(row.p4) || 0;
            });
        });

        const fmt = (v) => 'ï¿¥' + v.toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById('sum-p1').innerText = fmt(p1);
        document.getElementById('sum-p2').innerText = fmt(p2);
        document.getElementById('sum-p3').innerText = fmt(p3);
        document.getElementById('sum-p4').innerText = fmt(p4);
        document.getElementById('sum-grand').innerText = fmt(p1 + p2 + p3 + p4);
    };

    // å…¶ä»–åŸæœ‰åŠŸèƒ½é€»è¾‘
    window.updateVal = (d,r,k,v) => { window.trips[window.activeId].days[d].rows[r][k]=v; if(['loc','t1','h_t'].includes(k)) renderTable(); window.saveToCloud(); };
    window.updateMath = (d,r,k,v) => { window.trips[window.activeId].days[d].rows[r][k]=parseMath(v); updateStats(); window.saveToCloud(); };
    window.updateDayDate = (d,v) => { window.trips[window.activeId].days[d].date=v; window.saveToCloud(); };
    window.addTrip = () => { const n=prompt("è¡Œç¨‹åç§°"); if(n){ const id='t'+Date.now(); window.trips[id]={name:n, days:[{date:'', rows:[{loc:'',time:'09:00',t1:'',p1:0,t2:'',p2:0,h_t:'',p3:0,t4:'',p4:0}]}]}; window.saveToCloud(); loadTrip(id); } };
    window.loadTrip = (id) => { window.activeId=id; renderSidebar(); renderTable(); document.getElementById('content-area').style.display='block'; };
    window.renderSidebar = () => {
        const l = document.getElementById('trip-list'); l.innerHTML = '';
        Object.keys(window.trips).forEach(id => {
            const d = document.createElement('div'); d.className = `trip-item ${id===window.activeId?'active':''}`;
            d.innerText = "ğŸ“ " + window.trips[id].name; d.onclick = () => loadTrip(id); l.appendChild(d);
        });
    };
    window.addDay = () => { window.trips[window.activeId].days.push({date:'', rows:[{loc:'',time:'09:00',t1:'',p1:0,t2:'',p2:0,h_t:'',p3:0,t4:'',p4:0}]}); renderTable(); window.saveToCloud(); };
    window.delRow = (d,r) => { window.trips[window.activeId].days[d].rows.splice(r,1); if(window.trips[window.activeId].days[d].rows.length===0) window.trips[window.activeId].days.splice(d,1); renderTable(); window.saveToCloud(); };
    window.smartFillè”åŠ¨ = function(dIdx, rIdx, key, pKey) {
        const trip = window.trips[window.activeId];
        const rawInput = trip.days[dIdx].rows[rIdx][pKey] || "0";
        const contentName = trip.days[dIdx].rows[rIdx][key];
        if(!contentName) return;
        let involvedDayIndices = [dIdx];
        let stopSearch = false;
        for (let cd = dIdx; cd < trip.days.length; cd++) {
            if(stopSearch) break;
            let startRow = (cd === dIdx) ? rIdx + 1 : 0;
            for (let cr = startRow; cr < trip.days[cd].rows.length; cr++) {
                if (trip.days[cd].rows[cr][key] && trip.days[cd].rows[cr][key].trim() !== "") { stopSearch = true; break; }
                if (!involvedDayIndices.includes(cd)) involvedDayIndices.push(cd);
            }
        }
        let dayCount = involvedDayIndices.length;
        let payDayCount = dayCount;
        if (key === 'h_t' && dayCount > 1) {
            if (confirm("æŒ‰â€œæ™šæ•°â€å¹³æ‘Šè¯·ç‚¹ç¡®å®šï¼ˆæœ€åä¸€å¤©ä¸æ”¶é’±ï¼‰\næŒ‰â€œå¤©æ•°â€å¹³æ‘Šè¯·ç‚¹å–æ¶ˆï¼ˆæ¯å¤©å‡è®¡è´¹ï¼‰")) payDayCount = dayCount - 1;
        }
        let totalSum = parseMath(rawInput.toString());
        let per = Math.floor((totalSum / payDayCount) * 100) / 100;
        let last = (totalSum - (per * (Math.max(0, payDayCount - 1)))).toFixed(2);
        involvedDayIndices.forEach((dIdxCur, seq) => {
            trip.days[dIdxCur].rows.forEach((row, crIdx) => {
                if (!(dIdxCur === dIdx && crIdx < rIdx)) {
                    if (row[key] === "" || row[key] === contentName) {
                        row[key] = contentName;
                        if (crIdx === 0 || (dIdxCur === dIdx && crIdx === rIdx)) {
                            row[pKey] = (seq === payDayCount - 1) ? Number(last) : (seq < payDayCount ? per : 0);
                        } else { row[pKey] = 0; }
                    }
                }
            });
        });
        renderTable(); window.saveToCloud();
    };
</script>
</body>
</html>
