<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç§äººæ—…è¡Œé«˜çº§å·¥ä½œå° v37.0 - Data Recover & Fix</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCDjsmMiLV3f80dyJGCNWkpmTnoYOrjoaI",
            authDomain: "my-movies-f84ad.firebaseapp.com",
            databaseURL: "https://my-movies-f84ad-default-rtdb.firebaseio.com",
            projectId: "my-movies-f84ad",
            storageBucket: "my-movies-f84ad.firebasestorage.app",
            messagingSenderId: "575473837602",
            appId: "1:575473837602:web:2e02c0ee50565e4426cc7b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const myID = "Personal_Travel_Data"; 
        window.dbRef = ref(db, 'travelData/' + myID);

        window.trips = {}; 
        window.activeId = null;

        onValue(window.dbRef, (snapshot) => {
            const data = snapshot.val();
            // --- å…¼å®¹æ€§ä¿®å¤ï¼šå¦‚æœå‘ç°æ•°æ®å­˜åœ¨ä½†æ²¡åŠ è½½ï¼Œå¼ºåˆ¶æ ¼å¼åŒ– ---
            window.trips = data || {};
            if (window.trips && typeof window.trips === 'object') {
                Object.keys(window.trips).forEach(tId => {
                    window.trips[tId].days.forEach(day => {
                        day.rows.forEach(row => {
                            if (!row.mergedCells) row.mergedCells = {}; // è¡¥å…¨ç¼ºå¤±æ ‡è®°
                        });
                    });
                });
            }
            
            document.getElementById('syncStatus').innerText = "â˜ï¸ æ•°æ®å·²åŒæ­¥";
            renderSidebar();
            if (window.activeId && window.trips[window.activeId]) {
                renderTable();
            } else if (Object.keys(window.trips).length > 0 && !window.activeId) {
                loadTrip(Object.keys(window.trips)[0]);
            }
        });

        window.saveToCloud = function() {
            set(window.dbRef, window.trips);
            document.getElementById('syncStatus').innerText = "âŒ› æ­£åœ¨å­˜è‡³äº‘ç«¯...";
        };
    </script>

    <style>
        :root {
            --sidebar-bg: #1e293b;
            --accent: #3b82f6;
            --bg-main: #f8fafc;
            --border-color: #e2e8f0;
            --text-main: #1e293b;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg-main); overflow: hidden; }

        /* ä¾§è¾¹æ  */
        #sidebar { width: 240px; background: var(--sidebar-bg); color: #f8fafc; display: flex; flex-direction: column; flex-shrink: 0; }
        .side-header { padding: 20px; background: #0f172a; display: flex; justify-content: space-between; align-items: center; }
        .trip-item { padding: 12px 20px; cursor: pointer; color: #94a3b8; font-size: 14px; border-radius: 8px; margin: 4px 10px; }
        .trip-item.active { background: var(--accent); color: white; }

        /* ä¸»åŒºåŸŸ */
        #main { flex: 1; overflow: auto; padding: 20px; }
        .excel-box { background: white; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 4px 20px rgba(0,0,0,0.05); overflow: hidden; }
        
        table { border-collapse: collapse; width: 100%; table-layout: auto; min-width: 1100px; }
        th { background: #f8fafc; color: #64748b; font-size: 12px; padding: 12px 5px; border: 1px solid var(--border-color); }
        td { border: 1px solid var(--border-color); vertical-align: top; position: relative; }

        /* è¾“å…¥æ¡†è‡ªé€‚åº” */
        .cell-input {
            width: 100%; border: none; background: transparent; padding: 10px 5px;
            font-size: 13px; text-align: center; outline: none; display: block;
            resize: none; overflow: hidden; box-sizing: border-box; min-height: 40px;
        }

        .day-odd { background: #fff; }
        .day-even { background: #f9fafb; }
        .day-sep { border-top: 3px solid #cbd5e1 !important; }

        /* æŒ‰é’® */
        .fill-btn { 
            position: absolute; right: 2px; top: 2px; cursor: pointer; z-index: 10;
            background: #eff6ff; color: #3b82f6; border: 1px solid #3b82f6;
            width: 16px; height: 16px; font-size: 10px; border-radius: 4px;
            display: flex; align-items: center; justify-content: center; opacity: 0;
        }
        td:hover .fill-btn { opacity: 1; }
        .split-btn {
            position: absolute; left: 2px; top: 2px; cursor: pointer; z-index: 10;
            background: #fef2f2; color: #ef4444; border: 1px solid #ef4444;
            width: 16px; height: 16px; font-size: 10px; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
        }

        .add-row-trigger {
            position: absolute; bottom: -8px; right: 0; width: 20px; height: 20px;
            background: #3b82f6; color: white; border-radius: 50%; border:none;
            cursor: pointer; opacity: 0; z-index: 20; display: flex; align-items: center; justify-content: center;
        }
        tr:hover .add-row-trigger { opacity: 1; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="side-header"><b>è¡Œç¨‹è®¡åˆ’</b><button onclick="addTrip()" style="cursor:pointer">+</button></div>
    <div id="trip-list"></div>
    <div id="syncStatus" style="padding:10px; font-size:10px">ğŸ“¡ è¿æ¥ä¸­...</div>
</div>

<div id="main">
    <div id="content-area" style="display:none">
        <div style="margin-bottom: 15px;">
            <button onclick="addDay()" style="padding:8px 15px; background:#10b981; color:white; border:none; border-radius:6px; cursor:pointer">â˜€ï¸ æ–°å¢ä¸€å¤©</button>
        </div>
        <div class="excel-box">
            <table>
                <thead>
                    <tr>
                        <th width="40">å¤©</th><th width="100">æ—¥æœŸ</th><th width="110">æ‰€åœ¨åœ°</th><th width="80">æ—¶é—´</th>
                        <th>äº¤é€šè¯¦æƒ…</th><th width="60">é‡‘é¢</th><th>è¡Œç¨‹å®‰æ’</th><th width="60">é‡‘é¢</th>
                        <th>é…’åº—åç§°</th><th width="60">é‡‘é¢</th><th>é¤é¥®</th><th width="60">é‡‘é¢</th>
                        <th width="30">åˆ </th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function renderTable() {
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';
        const trip = window.trips[window.activeId];
        if(!trip) return;

        trip.days.forEach((day, dIdx) => {
            day.rows.forEach((row, rIdx) => {
                const tr = document.createElement('tr');
                tr.className = (dIdx % 2 === 0) ? 'day-odd' : 'day-even';
                if (rIdx === 0) tr.classList.add('day-sep');

                // 1. å›ºå®šåˆ— (å¤©æ•°/æ—¥æœŸ)
                if (rIdx === 0) {
                    tr.innerHTML += `<td rowspan="${day.rows.length}" style="text-align:center; font-weight:bold; vertical-align:middle">D${dIdx+1}</td>`;
                    tr.innerHTML += `<td rowspan="${day.rows.length}" style="vertical-align:middle; text-align:center">
                        <input type="date" value="${day.date}" onchange="updateDayDate(${dIdx}, this.value)" style="width:90%; border:none; background:transparent">
                    </td>`;
                }

                // 2. åŠ¨æ€åˆå¹¶åˆ—
                const keys = ['loc', 'time', 't1', 'p1', 't2', 'p2', 'h_t', 'p3', 't4', 'p4'];
                keys.forEach(key => {
                    if (isMerged(day.rows, rIdx, key)) return; // è¢«åˆå¹¶åˆ™è·³è¿‡

                    const span = countSpan(day.rows, rIdx, key);
                    const td = document.createElement('td');
                    if (span > 1) td.rowSpan = span;

                    const area = document.createElement('textarea');
                    area.className = 'cell-input';
                    area.value = row[key] || '';
                    area.onblur = (e) => updateRowVal(dIdx, rIdx, key, e.target.value);
                    area.oninput = function() { autoHeight(this); };
                    
                    td.appendChild(area);

                    // åˆå¹¶æŒ‰é’®
                    const fBtn = document.createElement('div');
                    fBtn.className = 'fill-btn'; fBtn.innerText = 'â†“';
                    fBtn.onclick = () => doMerge(dIdx, rIdx, key);
                    td.appendChild(fBtn);

                    // æ‹†åˆ†æŒ‰é’®
                    if (span > 1) {
                        const sBtn = document.createElement('div');
                        sBtn.className = 'split-btn'; sBtn.innerText = 'Ã—';
                        sBtn.onclick = () => doSplit(dIdx, rIdx, key);
                        td.appendChild(sBtn);
                    }

                    tr.appendChild(td);
                    setTimeout(() => autoHeight(area), 0);
                });

                // 3. æ“ä½œ
                tr.innerHTML += `<td style="text-align:center; vertical-align:middle; color:#cbd5e1; cursor:pointer" onclick="delRow(${dIdx},${rIdx})">âœ•
                    <button class="add-row-trigger" onclick="event.stopPropagation(); insertRow(${dIdx},${rIdx})">+</button>
                </td>`;
                tbody.appendChild(tr);
            });
        });
    }

    function autoHeight(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
    
    // åˆå¹¶é€»è¾‘ï¼šæ˜ç¡®æ£€æŸ¥æ ‡è¯†
    function isMerged(rows, rIdx, key) {
        if (rIdx === 0) return false;
        return rows[rIdx].mergedCells && rows[rIdx].mergedCells[key] === true;
    }

    function countSpan(rows, rIdx, key) {
        let span = 1;
        for (let i = rIdx + 1; i < rows.length; i++) {
            if (rows[i].mergedCells && rows[i].mergedCells[key] === true) span++;
            else break;
        }
        return span;
    }

    // æ‰§è¡Œåˆå¹¶
    window.doMerge = function(dIdx, rIdx, key) {
        const rows = window.trips[window.activeId].days[dIdx].rows;
        if (rIdx + 1 < rows.length) {
            if (!rows[rIdx+1].mergedCells) rows[rIdx+1].mergedCells = {};
            rows[rIdx+1].mergedCells[key] = true;
            rows[rIdx+1][key] = rows[rIdx][key]; // åŒæ­¥å†…å®¹
            renderTable(); window.saveToCloud();
        } else {
            alert("å·²ç»æ˜¯æœ€åä¸€è¡Œäº†ï¼Œè¯·å…ˆæ–°å¢è¡Œ");
        }
    };

    window.doSplit = function(dIdx, rIdx, key) {
        const rows = window.trips[window.activeId].days[dIdx].rows;
        const span = countSpan(rows, rIdx, key);
        for(let i=1; i<span; i++) {
            if(rows[rIdx+i].mergedCells) rows[rIdx+i].mergedCells[key] = false;
        }
        renderTable(); window.saveToCloud();
    };

    function updateRowVal(dIdx, rIdx, key, val) {
        const rows = window.trips[window.activeId].days[dIdx].rows;
        rows[rIdx][key] = val;
        // å¦‚æœæ˜¯åˆå¹¶ç»„ï¼ŒåŒæ­¥æ‰€æœ‰å­é¡¹
        const span = countSpan(rows, rIdx, key);
        for(let i=1; i<span; i++) { rows[rIdx+i][key] = val; }
        window.saveToCloud();
    }

    // åŸºç¡€ç®¡ç†
    function updateDayDate(dIdx, val) { window.trips[window.activeId].days[dIdx].date = val; window.saveToCloud(); }
    function addTrip() { const name = prompt("è¡Œç¨‹åç§°"); if(name){ const id='t_'+Date.now(); window.trips[id]={name, days:[{date:'', rows:[{loc:'',time:'',t1:'',p1:0,t2:'',p2:0,h_t:'',p3:0,t4:'',p4:0}]}]}; window.saveToCloud(); loadTrip(id); } }
    function loadTrip(id) { window.activeId = id; renderSidebar(); renderTable(); document.getElementById('content-area').style.display='block'; }
    function renderSidebar() {
        const list = document.getElementById('trip-list'); list.innerHTML = '';
        Object.keys(window.trips).forEach(id => {
            const div = document.createElement('div');
            div.className = `trip-item ${id === window.activeId ? 'active' : ''}`;
            div.innerText = "ğŸ“ " + window.trips[id].name;
            div.onclick = () => loadTrip(id);
            list.appendChild(div);
        });
    }
    function addDay() { window.trips[window.activeId].days.push({date:'', rows:[{loc:'',time:'',t1:'',p1:0,t2:'',p2:0,h_t:'',p3:0,t4:'',p4:0}]}); renderTable(); window.saveToCloud(); }
    function insertRow(dIdx, rIdx) { window.trips[window.activeId].days[dIdx].rows.splice(rIdx+1, 0, {loc:'',time:'',t1:'',p1:0,t2:'',p2:0,h_t:'',p3:0,t4:'',p4:0}); renderTable(); window.saveToCloud(); }
    function delRow(dIdx, rIdx) { if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")){ window.trips[window.activeId].days[dIdx].rows.splice(rIdx, 1); if(window.trips[window.activeId].days[dIdx].rows.length===0) window.trips[window.activeId].days.splice(dIdx, 1); renderTable(); window.saveToCloud(); } }
</script>
</body>
</html>
