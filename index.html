<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç§äººæ—…è¡Œé«˜çº§å·¥ä½œå° v38.1 - æ™ºèƒ½åˆå¹¶ä¿®å¤ç‰ˆ</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ä¸¥æ ¼ä½¿ç”¨ v36.6 çš„åŸå§‹é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCDjsmMiLV3f80dyJGCNWkpmTnoYOrjoaI",
            authDomain: "my-movies-f84ad.firebaseapp.com",
            databaseURL: "https://my-movies-f84ad-default-rtdb.firebaseio.com",
            projectId: "my-movies-f84ad",
            storageBucket: "my-movies-f84ad.firebasestorage.app",
            messagingSenderId: "575473837602",
            appId: "1:575473837602:web:2e02c0ee50565e4426cc7b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const myID = "Personal_Travel_Data"; 
        window.dbRef = ref(db, 'travelData/' + myID);

        window.trips = {}; 
        window.activeId = null;

        // æ¢å¤ v36.6 çš„æ•°æ®ç›‘å¬é€»è¾‘
        onValue(window.dbRef, (snapshot) => {
            const data = snapshot.val();
            window.trips = data || {};
            document.getElementById('syncStatus').innerText = "â˜ï¸ æ•°æ®å·²ä»äº‘ç«¯åŒæ­¥";
            renderSidebar();
            if (window.activeId && window.trips[window.activeId]) {
                renderTable();
            } else if (Object.keys(window.trips).length > 0 && !window.activeId) {
                // å¦‚æœæ²¡æœ‰é€‰ä¸­ï¼Œé»˜è®¤åŠ è½½ç¬¬ä¸€ä¸ªè¡Œç¨‹
                loadTrip(Object.keys(window.trips)[0]);
            }
        });

        window.saveToCloud = () => set(window.dbRef, window.trips);
    </script>

    <style>
        :root { --sidebar-bg: #1e293b; --accent: #3b82f6; --bg-main: #f8fafc; --border-color: #e2e8f0; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg-main); overflow: hidden; }
        #sidebar { width: 260px; background: var(--sidebar-bg); color: #f8fafc; display: flex; flex-direction: column; flex-shrink: 0; }
        .side-header { padding: 20px; font-size: 18px; font-weight: bold; background: #0f172a; display: flex; justify-content: space-between; align-items: center; }
        #trip-list { flex: 1; overflow-y: auto; padding: 10px 0; }
        .trip-item { padding: 12px 20px; cursor: pointer; color: #94a3b8; margin: 4px 12px; border-radius: 8px; font-size: 14px; }
        .trip-item.active { background: var(--accent); color: white; }
        #main { flex: 1; overflow: auto; padding: 25px; }
        .excel-box { background: white; padding: 15px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        table { border-collapse: collapse; width: 100%; min-width: 1100px; font-size: 13px; table-layout: fixed; }
        th { background: #f1f5f9; color: #475569; padding: 10px 5px; border: 1px solid var(--border-color); }
        td { border: 1px solid var(--border-color); height: 38px; position: relative; vertical-align: middle; background: white; }
        input { width: 100%; height: 100%; border: none; background: transparent; text-align: center; outline: none; }
        .day-odd { background-color: #ffffff; }
        .day-even { background-color: #f8fafc; }
        .day-start { border-top: 2px solid #94a3b8 !important; }
        
        .fill-btn { 
            position: absolute; right: 2px; top: 2px; cursor: pointer; 
            background: #fff; color: #3b82f6; border: 1px solid #3b82f6;
            width: 16px; height: 16px; font-size: 10px; border-radius: 4px;
            display: flex; align-items: center; justify-content: center; opacity: 0; z-index: 10;
        }
        td:hover .fill-btn { opacity: 1; }
        .btn-green { background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-bottom: 15px; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="side-header"><span>âœˆï¸ è¡Œç¨‹ç®¡ç†</span><button onclick="addTrip()" style="cursor:pointer; background:var(--accent); border:none; color:white; padding:2px 8px; border-radius:4px">+</button></div>
    <div id="trip-list"></div>
    <div id="syncStatus" style="padding:15px; font-size:11px; color:#64748b">ğŸ“¡ æ­£åœ¨åŒæ­¥...</div>
</div>

<div id="main">
    <div id="content-area" style="display:none">
        <button class="btn-green" onclick="addDay()">+ æ–°å¢æ—¥æœŸ</button>
        <div class="excel-box">
            <table id="main-table">
                <thead>
                    <tr>
                        <th rowspan="2" style="width:45px">å¤©</th><th rowspan="2" style="width:110px">æ—¥æœŸ</th>
                        <th rowspan="2" style="width:120px">æ‰€åœ¨åœ°</th><th rowspan="2" style="width:80px">æ—¶é—´</th>
                        <th colspan="2">äº¤é€š</th><th colspan="2">é¡¹ç›®</th>
                        <th colspan="2">é…’åº—</th><th colspan="2">é¤é¥®</th>
                        <th rowspan="2" style="width:35px">åˆ </th>
                    </tr>
                    <tr>
                        <th>è¯¦æƒ…</th><th>é‡‘é¢</th><th>è¯¦æƒ…</th><th>é‡‘é¢</th>
                        <th>åç§°</th><th>é‡‘é¢</th><th>è¯¦æƒ…</th><th>é‡‘é¢</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒæ¸²æŸ“å‡½æ•° ---
    function renderTable() {
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';
        const trip = window.trips[window.activeId];
        if(!trip) return;

        trip.days.forEach((day, dIdx) => {
            const dayClass = (dIdx % 2 === 0) ? 'day-odd' : 'day-even';
            day.rows.forEach((row, rIdx) => {
                const tr = document.createElement('tr');
                tr.className = dayClass;
                if (rIdx === 0) tr.classList.add('day-start');

                // 1. å¤©æ•°å’Œæ—¥æœŸ (å›ºå®šåˆå¹¶)
                if (rIdx === 0) {
                    tr.innerHTML += `<td rowspan="${day.rows.length}" style="text-align:center; font-weight:bold; background:inherit">D${dIdx+1}</td>`;
                    tr.innerHTML += `<td rowspan="${day.rows.length}" style="background:inherit"><input type="date" value="${day.date}" onchange="window.trips['${window.activeId}'].days[${dIdx}].date=this.value;window.saveToCloud()"></td>`;
                }

                // 2. å…¨éƒ¨å†…å®¹åˆ—ï¼šæ™ºèƒ½åˆå¹¶é€»è¾‘
                const colKeys = [
                    {key: 'loc', bg: (dIdx%2===0?'#f0f9ff':'#e0f2fe')}, {key: 'time', bg: 'transparent'},
                    {key: 't1', bg: 'transparent'}, {key: 'p1', bg: 'transparent'},
                    {key: 't2', bg: 'transparent'}, {key: 'p2', bg: 'transparent'},
                    {key: 'h_t', bg: (dIdx%2===0?'#fefce8':'#fef9c3')}, {key: 'p3', bg: (dIdx%2===0?'#fefce8':'#fef9c3')},
                    {key: 't4', bg: 'transparent'}, {key: 'p4', bg: 'transparent'}
                ];

                colKeys.forEach(col => {
                    // å¦‚æœè¯¥å•å…ƒæ ¼è¢«æ ‡è®°ä¸ºâ€œè¢«åˆå¹¶(m_)â€ï¼Œåˆ™è·³è¿‡æ¸²æŸ“
                    if (rIdx > 0 && row['m_' + col.key]) return;

                    // è®¡ç®—è¿™ä¸ªåˆå¹¶å—è¦è·¨è¶Šå¤šå°‘è¡Œ
                    let span = 1;
                    for (let i = rIdx + 1; i < day.rows.length; i++) {
                        if (day.rows[i]['m_' + col.key]) span++;
                        else break;
                    }

                    const td = document.createElement('td');
                    if (span > 1) td.rowSpan = span;
                    td.style.backgroundColor = col.bg;

                    const input = document.createElement('input');
                    input.value = row[col.key] || '';
                    input.onblur = (e) => updateVal(dIdx, rIdx, col.key, e.target.value);
                    
                    td.appendChild(input);
                    // åªè¦ä¸æ˜¯æœ€åä¸€è¡Œï¼Œå°±æ˜¾ç¤ºåˆå¹¶ç®­å¤´
                    if (rIdx < day.rows.length - 1) {
                        const btn = document.createElement('span');
                        btn.className = 'fill-btn';
                        btn.innerHTML = 'â†“';
                        btn.onclick = () => smartFillDown(dIdx, rIdx, col.key);
                        td.appendChild(btn);
                    }
                    tr.appendChild(td);
                });

                tr.innerHTML += `<td style="text-align:center; cursor:pointer; color:#ccc" onclick="delRow(${dIdx},${rIdx})">âœ•</td>`;
                tbody.appendChild(tr);
            });
        });
    }

    // --- æ™ºèƒ½å¡«å……é€»è¾‘ï¼šå®ç°â€œç›´åˆ°ä¸‹ä¸€ä¸ªæœ‰å†…å®¹çš„æ ¼å­åœæ­¢â€ ---
    window.smartFillDown = function(dIdx, rIdx, key) {
        const day = window.trips[window.activeId].days[dIdx];
        const val = day.rows[rIdx][key];
        
        // ä»å½“å‰è¡Œä¸‹ä¸€è¡Œå¼€å§‹æ£€æŸ¥
        for (let i = rIdx + 1; i < day.rows.length; i++) {
            const targetVal = (day.rows[i][key] || "").toString().trim();
            
            // å¦‚æœä¸‹é¢è¿™è¡ŒåŸæœ¬å°±æœ‰å†…å®¹ï¼Œä¸”æ²¡è¢«åˆå¹¶è¿‡ï¼Œå°±åœæ­¢åˆå¹¶
            if (targetVal !== "" && !day.rows[i]['m_' + key]) break;
            
            // å¦åˆ™ï¼Œå¡«å……å†…å®¹å¹¶æ‰“ä¸Šåˆå¹¶æ ‡è®°
            day.rows[i][key] = val;
            day.rows[i]['m_' + key] = true;
        }
        window.saveToCloud();
        renderTable();
    };

    // --- æ•°æ®ä¿å­˜é€»è¾‘ ---
    window.updateVal = function(dIdx, rIdx, key, val) {
        const day = window.trips[window.activeId].days[dIdx];
        day.rows[rIdx][key] = val;
        // å¦‚æœè¯¥å•å…ƒæ ¼æ˜¯åˆå¹¶å—çš„å¤´éƒ¨ï¼ŒåŒæ­¥æ›´æ–°ä¸‹æ–¹æ‰€æœ‰è¢«åˆå¹¶çš„å•å…ƒæ ¼å†…å®¹
        for (let i = rIdx + 1; i < day.rows.length; i++) {
            if (day.rows[i]['m_' + key]) {
                day.rows[i][key] = val;
            } else {
                break;
            }
        }
        window.saveToCloud();
    };

    // --- åŸºç¡€ç®¡ç†ï¼ˆå®Œå…¨åŒæ­¥ v36.6ï¼‰ ---
    window.addTrip = function() { const n = prompt("è¡Œç¨‹åç§°"); if(n){ const id='t'+Date.now(); window.trips[id]={name:n, days:[{date:'', rows:[{loc:'',time:'',t1:'',p1:0,t2:'',p2:0,h_t:'',p3:0,t4:'',p4:0}]}]}; window.saveToCloud(); loadTrip(id); } };
    window.loadTrip = function(id) { window.activeId = id; renderSidebar(); renderTable(); document.getElementById('content-area').style.display = 'block'; };
    window.renderSidebar = function() {
        const l = document.getElementById('trip-list'); l.innerHTML = '';
        Object.keys(window.trips).forEach(id => {
            const d = document.createElement('div'); d.className = `trip-item ${id===window.activeId?'active':''}`;
            d.innerText = "ğŸ“ " + window.trips[id].name; d.onclick = () => loadTrip(id); l.appendChild(d);
        });
    };
    window.addDay = function() { window.trips[window.activeId].days.push({date:'', rows:[{loc:'',time:'',t1:'',p1:0,t2:'',p2:0,h_t:'',p3:0,t4:'',p4:0}]}); renderTable(); window.saveToCloud(); };
    window.delRow = function(dIdx, rIdx) { 
        const day = window.trips[window.activeId].days[dIdx];
        day.rows.splice(rIdx, 1);
        if (day.rows.length === 0) window.trips[window.activeId].days.splice(dIdx, 1);
        renderTable(); window.saveToCloud(); 
    };
</script>
</body>
</html>
